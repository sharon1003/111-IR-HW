installing azure active directory connect formerly aadsync and dir syncwhat you need to know about aadconnect  our experiences with aadconnect and office 365 by david parizek and henry verlander aadconnect can help simplify active directory users’ experiences with office 365 and eliminate the need for multiple passwords without adding major infrastructure however we found that the setup process was somewhat difficult to navigate that there was much more to the program than first met the eye in this article we are attempting to provide a brief and concise stepbystep guide for using aadconnect with office 365 for email purposes introduction info stream does a lot of office 365 email migrations so when we heard about microsoft’s azure active directory connection tool previously known as dir sync it definitely sounded like something we’d want to use after migrating a client to office 365 end users would often have problems with usernames and passwords in the two environments it was relatively easy for users to get confused the number one feature that drew infostream to aadconnect is “password synchronization” that feature can definitely simplify the experience for end users we dove into the deep end of the pool and are now using aadconnect at a number of our clients our usage of aadconnect has been confined exclusively to syncing between local active directory environments and office 365 as with all microsoft products there is more than one version it gets confusing with this product because microsoft changed names with each new version directory sync dir sync was released and tied to office 365 becoming the default name everybody uses azure active directory sync aadsync was rolled out with the azure cloud platform and has several additional capabilities as well as the password sync azure active directory connect is the newest version and is linked below as a newer version that still does what we want aadconnect is the version this paper will focus on if you are working with dir sync or aadsync the theory and the steps will be similar but some of the command line syntax may change locations of critical files windows management framework 40 required before installing aadconnecthttpwwwmicrosoftcomenusdownloaddetailsaspxid40855microsoft azure active directory sync services can be downloaded from the following locationhttpgomicrosoftcomfwlink link id511690miis client for azure active directory for configuration is at“cprogram filesmicrosoft azure ad syncuishell”microsoft azure directory sync client command“cprogram filesmicrosoft azure ad syncbindirectory sync client cmdexe”scenarios when your organization decides to implement aadconnect it is critical to know where you are in the following scenarios we have grouped our own experiences into three distinct scenarios each scenario is designed to be a complete series of steps to implement aadconnect the scenarios vary depending on the status of inhouse exchange and office 365 at the time you start implementation we suggest that you read the headings of each of the following scenarios carefully and decide which one applies to your organization then follow the steps that apply to you in that section scenario 1 inhouse exchange is active with a planned migration to office 365 not yet underway one of the hardest parts of using aadconnect is matching of local users to cloud users in this scenario it is easy the office365 environment is empty so when aadconnect doesn’t find a matching user to sync with it creates a new user and automatically links them together the sequence of steps is as follows in local aduc move all local users groups and contacts to a new ou named office365 you can have subou’s but there should be a parent ou which defines the objects which will be syncing to office 365 change all users’ upn to match their email address example contosocom not contosolocal in aduc properties here’s how to do that httpstechnetmicrosoftcomenuslibrarycc772007aspx after creating the new suffix you must apply it to all users in aduc make sure that each user has their default email address filled in under the general properties tab in aduc enable directory synchronization in office 365go to office 365 admin center click on users then active users click on “set up” next to active directory synchronization install aadconnect but do not sync configure ou filtering and mailbox guid exclusion first ou filteringi httpmsexchangegurucom20120810office3652excluding mailbox guidi httpwwwcheddoncoukmsexchmailboxguidoffice365ii if you don’t exclude the mailbox guid office 365 will not allow you to assign licenses to the cloud mailboxes although this may appear obvious we highly recommended that you do not include the o365 account used to authenticate the directory sync as a directory sync account if necessary you can create an extra global admin account without a license to be used as the directory sync administrator account perform sync upon initial sync if office 365 is empty dir sync will create all the new users and link them to their counterpart in local active directory there are several syncs that are required to update both office 365 and active directory microsoft recommends that for future manual dir sync’s you use the directory sync client command this performs all of the full and delta sync’s for both connectors that would occur during a scheduled automated sync the recommended sync tool is not listed in the start menu it’s located ati “cprogram filesmicrosoft azure ad syncbindirectory sync client cmdexeadding a shortcut to the desktop for this command is also recommended if you do fill in the “start in” field withi cprogram filesmicrosoft azure ad syncbinnote the first sync often fails to update passwords the website will show that the account is synced with active directory but the passwords will still be different changing the password in active directory will force another sync and the passwords will be matched optional uninstall exchange see wrap upuninstalling exchange will remove all users’ email addresses from active directory and you must be prepared for that before allowing synchronization to occur after the migration is completed and exchange is disabled most of the management of users and groups is done locally for example distribution group memberships are managed locally with the changes syncing to office365 scenario 2 – the organization has already migrated to office 365 and exchange is still installed in this scenario the office 365 mailboxes were created manually with no sync to local active directory exchange has been disabled but not uninstalled from active directory all mailbox management is being performed in the office 365 portal users are forced to manage 2 usernames and 2 passwords here are the steps if you are a scenario 2 organization move all local users groups and contacts to a new aduc ou structure named office365 you can have subou’s but there should be a parent ou which defines the objects which will be syncing to office 365 do not change the users’ upn leave all users with the existing local suffix enable directory synchronization in office 365go to office 365 admin center click on users then active users click on “set up” next to active directory synchronization install aadconnect and configure the ou filter before performing a sync if the filter is not set then aadconnect will find all the users in the entire active directory and try to sync them here is a good step by step for configuring “organizational units based filtering”httpmsexchangegurucom20120810office3652although this may appear obvious we highly recommended that you do not include the o365 account used to authenticate the directory sync as a directory sync account if necessary you can create an extra global admin account without a license to be used as the directory sync administrator account configure mailbox guid filtering before performing the first synchttpwwwcheddoncoukmsexchmailboxguidoffice365perform the procedures in “smtp matching” from the article belowhttpssupportmicrosoftcomenuskb2641663enus perform initial sync run aadconnect wizard there are several syncs that are required to update both office 365 and active directory microsoft recommends that for future manual aadconnect’s you use the directory sync client command this performs all of the full and delta sync’s for both connectors that would occur during a scheduled automated sync the recommended sync tool is not listed in the start menu it’s located ati “cprogram filesmicrosoft azure ad syncbindirectory sync client cmdexeadding a shortcut to the desktop for this command is also recommended if you do fill in the “start in” field withi cprogram filesmicrosoft azure ad syncbinnote the first sync often fails to update passwords the website will show that the account is synced with active directory but the passwords will still be different changing the password in active directory will force another sync and the passwords will be matched optional uninstall exchange see wrap upuninstalling exchange will remove all users’ email addresses from local active directory you must be prepared for that before allowing synchronization to occur with a little luck at this step users will be matched via default smtp address and then linked with their “immutable id” if things go wrong you might see duplicate users appear in office 365 in that case use power shell to permanently delete the duplicates from office 365 and try again from this point forward you must manage many of the users’ office 365 attributes from local active directory scenario 3 – the organization has already migrated to office 365 and exchange never was installed locally or is completely removed when exchange does not exist in the local active directory the users do not have email addresses included in their aduc properties in this scenario technicians must use the aduc advanced attribute “proxy addresses” field to manage the data that is synced to office 365 the most critical part of implementing aadconnect in scenario 3 is to perform the steps in the proper sequence here is our advice move all local users groups and contacts to a new ou named office365a you can have subou’s but there should be a parent ou which defines the objects which will be syncing to office 3652 enable directory synchronization in office 365go to office 365 admin center click on users then active users click on “set up” next to active directory synchronization change all users’ upn to match their email address example contosocom not contosolocal in aduc properties here’s how to do that httpstechnetmicrosoftcomenuslibrarycc772007aspx after creating the new suffix you must apply it to all users in aduc edit users’ proxy addresses enter the default email address in the “general” properties tab for each user or group in aduc manually open each user and group in aduc advanced propertiesi go to the attribute editor tabii scroll down to proxy addressesiii enter all of the email addresses for that user or group the default address must be formatted as smtp jsmithcontosocom alternate addresses must be added with the “smtp” in lower case do the same for all users and groups if a user is matched and synced to office 365 when they do not have a local email address then dir sync will remove all existing email addresses and replace them with jsmithcontosoonmicrosoftcom install aadconnect and configure the ou filter before performing a sync if the filter is not set then aadconnect will find all the users in the entire active directory and try to sync them article for configuring “organizational units based filtering”i httpmsexchangegurucom20120810office3652although this may appear obvious we highly recommended that you do not include the o365 account used to authenticate the directory sync as a directory sync account if necessary you can create an extra global admin account without a license to be used as the directory sync administrator account perform the procedures in “smtp matching” from the article belowhttpssupportmicrosoftcomenuskb2641663enus perform sync run the aadsync wizard there are several syncs that are required to update both office 365 and active directory microsoft recommends that for future manual dir sync’s you use the directory sync client command this performs all of the full and delta sync’s for both connectors that would occur during a scheduled automated sync the recommended sync tool is not listed in the start menu it’s located ati “cprogram filesmicrosoft azure ad syncbindirectory sync client cmdexeadding a shortcut to the desktop for this command is also recommended if you do fill in the “start in” field withi cprogram filesmicrosoft azure ad syncbinnote the first sync often fails to update passwords the website will show that the account is synced with active directory but the passwords will still be different changing the password in active directory will force another sync and the passwords will be matched with a little luck here users will be matched via initial smtp address then permanently linked with their “immutable id” and there will be no duplicates created from this point forward you must manage many of the users’ office 365 attributes from local active directory optional wrap up uninstall exchangetemporarily stop the synchronization schedule from running while completing the remaining stepsi to stop dir sync go to the cprogram fileswindows azure active directory sync folderii open the microsoft online dir sync schedulerexe config file with the notepad edit the “sync time interval” value to a higher number of hoursiii for aadconnect or aadsync go to “task scheduler” in administrative tools and edit the timing of the task there manually add email addresses to active directory objects users and groupsopen each user or group in aduc advanced properties viewgo to the attribute editor tabscroll down to proxy addresses enter all of the email addresses for the useri the default address must be formatted as smtp jsmithcontosocomii alternate addresses must be added with the “smtp” in lower caseiii do the same for users and groupsiv additionally enter the default email address under the “general” properties tab for each user or group in aduc uninstall exchange wwwinfostreamcc20111004removingexchange2007fromsmallbusinessserver2008reinitiate normal aadconnect synchronization interval by reversing step 1general tips there are several different versions of addsync and dir sync make sure you get the latest version the official name of the new version is azure active directory sync here is a good microsoft article about the differences in the versions httpsmsdnmicrosoftcomenuslibraryazuredn757582aspx aadsync will attempt to sync every user in the entire aduc if you don’t stop it make sure users are organized into ou’s and configure ou filtering immediately after installing dir sync we suggest starting with a “test ou” with only 1 or 2 test users in it when you have gotten a feel for it then change the ou filter or add more users synchronization mistakes and errors can be very difficult to fix if local users have user logon names which differ from their email addresses it can be confusing for them if the user logs on to their computer as jsmith but their email address starts with john s you will need to be careful when setting up user logon name in aduc make sure the local ad user logon name field matches the default email address conclusionaadconnect is a great tool for connecting two powerful systems active directory and office 365 in a world where everything needs a password and every password should be changed regularly limiting the number of those passwords is a great benefit for end users after being configured aadconnect does not require a lot of changes or maintenance so after the initial setup its simplifying features become more and more valuable as time goes on for more great tips and info please join our free newsletter by clicking here 