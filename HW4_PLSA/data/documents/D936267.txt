docs previous versions windows credentials management in windows authentication april 10 2013 22 minutes to read in this article credential input for user logon credential input for application and service logon local security authority security accounts manager sam database local domains and trusted domains cached credentials and validation credential storage and validation stored user names and passwords in windows vista and windows xpwindows vault and credential manager in windows 7certificates in windows authentication see also updated april 11 2013applies to windows 7 windows server 2008 windows server 2008 r2 windows vista this reference topic describes the different credential management processes windows credentials management is the process by which the operating system receives the credentials from the service or user and secures that information for future presentation to the authenticating target in the case of a domainjoined computer the authenticating target is the domain controller the credentials used in authentication are digital documents that associate the user’s identity to some form of proof of authenticity such as a certificate a password or a pin by default windows credentials are validated against the security accounts manager sam database on the local computer or against active directory on a domainjoined computer through the win logon service credentials are collected through user input on the logon user interface or coded through the api to be presented to the authenticating target local security information is stored in the registry under hkeylocalmachinesecurity stored information includes policy settings default security values and account information such as cached logon credentials a copy of the sam is also stored here although it is writeprotected the following diagram shows the components required and the paths that credentials take through the system to authenticate the user or process for a successful logon the following table correspond to the diagram above and describe each component that manages credentials in the authentication process at the point of logon authentication components for all systems component description user logon winlogonexe is the executable file responsible for managing secure user interactions the winlogon service initiates the logon process for windows operating systems by passing the credentials collected by user action on the secure desktop logon ui to the local security authority lsa through secur32dll application logon application or service logons not requiring interactive logon most processes initiated by the user run in user mode by using secur32dll whereas processes initiated at start up such as services run in kernel mode by using ksecddsys for more information about user mode and kernel mode see applications and user mode or services and kernel mode in this topic secur32dll the multiple authentication provider that forms the foundation of the authentication process lsasrvdll the lsa server service which both enforces security policies and acts as the security package manager for the lsa the lsa contains the negotiate function which selects either the ntlm or kerberos protocol after determining which protocol will be successful security support providers a set of providers that can individually invoke one or more authentication protocols the default set of providers can change with each version of windows and custom providers can be written netlogondll some of the services that the net logon service performs include maintains the computer’s secure channel not to be confused with schannel to a domain controller passes the user’s credentials through a secure channel to the domain controller and returns the domain sids and user rights for the user publishes service resource records in the domain name system dns and uses dns to resolve names to the internet protocol ip addresses of domain controllers implements the replication protocol based on remote procedure call rpc for synchronizing primary domain controllers pdcs and backup domain controllers bdcs samsrvdll the security accounts manager sam which stores local security accounts enforces locally stored policies and supports apis registry contains a copy of the sam database local security policy settings default security values and account information that is only accessible to the system credential input for user logon two architectures exist for credential input in windows in windows server 2008 and windows vista the graphical identification and authentication gina architecture was replaced with a credential provider model which made it possible to enumerate different logon types through the use of logon tiles graphical identification and authentication gina architecture the gina architecture applies to the windows server 2003 windows 2000 server windows xp and windows 2000 professional operating systems in these systems every interactive logon session creates a separate instance of the winlogon service the gina architecture is loaded into the process space used by winlogon receives and processes the credentials and makes the calls to the authentication interfaces through lsalogon user the instances of winlogon for an interactive logon run in session 0 session 0 hosts system services and other critical processes including the local security authority lsa process the following diagram shows the credential process for windows server 2003 windows 2000 server windows xp and windows 2000 professional credential provider architecture the credential provider architecture applies to windows server 2008 r2 windows server 2008 windows 7 and windows vista in these systems the credentials input architecture changed to an extensible design by using credential providers these providers are represented by the different logon tiles on the secure desktop that permit any number of logon scenarios—different accounts for the same user and different authentication methods such as password smart card and biometrics with the credential provider architecture winlogon always launches logon ui after it receives a sas event logon ui queries each credential provider for the number of different credential types the provider is configured to enumerate credential providers have the option of specifying one of these tiles as the default after all providers have enumerated their tiles logon ui displays them to the user the user interacts with a tile to supply their credentials logon ui submits these credentials for authentication combined with supporting hardware credential providers can extend windows to enable users to log on through biometric fingerprint retinal or voice recognition password pin and smart card certificate or any custom authentication package and schema that a thirdparty developer creates your organization can develop and deploy custom authentication mechanisms for all domain users and explicitly require users to use this custom logon mechanism credential providers are not enforcement mechanisms they are used to gather and serialize credentials the local authority and authentication packages enforce security credential providers can be designed to support single signon sso authenticating users to a secure network access point leveraging radius and other technologies as well as machine logon credential providers are also designed to support applicationspecific credential gathering and may be used for authenticating to network resources joining machines to a domain or providing administrator consent for user account control uac credential providers are registered on the computer and are responsible for the following describing the credential information required for authentication handling communication and logic with external authentication authorities packaging credentials for interactive and network logon packaging credentials for interactive and network logon includes the process of serialization serialization of credentials allows multiple logon tiles to be displayed on the logon ui therefore your organization can control the logon display—such as users target systems for logon prelogon access to the network and workstation lockunlock policies—through the use of customized credential providers multiple credential providers can coexist on the same computer single signon providers ssos may be developed as a standard credential provider or as a prelogonaccess provider each version of windows contains one default credential provider and one default prelogonaccess provider plap logon uithe credential provider enumerates the tiles for workstation logon the credential provider will typically serialize credentials for authentication to the local security authority this displays tiles specific for each user and specific to each users target systems unlock workstation the logon and authentication architecture allows a user to use tiles enumerated by the credential provider to unlock a workstation typically the currently logged on user is the default tile however if more than one user is logged on numerous tiles will be displayed change password the credential provider enumerates tiles in response to a user request to change their password or other private information such as a pin typically the currently logged on user is the default tile however if more than one user is logged on numerous tiles will be displayed credential uithe credential provider enumerates tiles based on the serialized credentials to be used for authentication on remote computers credential ui does not use the same instance of the provider as the logon ui unlock workstation or change password therefore state information cannot be maintained in the provider between instances of credential ui this results in one tile for each remote computer logon assuming the credentials have been properly serialized this scenario is also used for overtheshoulder prompting in user account control uac prelogonaccess provider the prelogonaccess provider plap permits users to make a connection to a network before logging on to the local computer when this provider is implemented the provider will not enumerate tiles on logon ui users will see them only after clicking the plap button logon is then handled through the prelogonaccess provider screen a plap is intended to be used in the following scenarios network authentication and computer logon are handled by different credential providers variations to this scenario include a user has the option of connecting to a network such as connecting to a virtual private network vpn before logging on to the machine but is not required to make this connection network authentication is required to retrieve information used during interactive authentication on the local computer multiple network authentications are followed by one of the other scenarios for example a user authenticates to an isp then authenticates to a vpn and then uses their user account credentials to log on locally cached credentials are disabled and a rasvpn connection is required before local logon to authenticate the user a domain user does not have a local account set up on a domainjoined computer and must establish a rasvpn connection before completing interactive logon network authentication and computer logon are handled by the same credential provider in this scenario the user is required to connect to the network before logging on to the computer the following diagram shows the credential process for windows server 2008 r2 windows server 2008 windows 7 and windows vista operating systems credential input for application and service logon windows authentication is designed to manage credentials for applications or services that do not require user interaction applications in user mode are limited in terms of what system resources they have access to while services can have unrestricted access to the system memory and external devices system services and transportlevel applications access an security support provider ssp through the security support provider interface sspi which provides functions for enumerating the security packages available on a system selecting a package and using that package to obtain an authenticated connection when a clientserver connection is authenticated the application on the client side of the connection sends credentials to the server using the sspi function initialize security context general the application on the server side of the connection responds with the sspi function accept security context general the sspi functions initialize security context general and accept security context general repeat until all the necessary authentication messages have been exchanged to either succeed or fail authentication after the connection has been authenticated the lsa on the server uses information from the client to build the security context which contains an access token the server can then call the sspi function impersonate security context to attach the access token to an impersonation thread for the service applications and user mode user mode in windows is composed of two systems capable of passing io requests to the appropriate kernel mode software drivers the environment system which runs applications written for many different types of operating systems and the integral system which operates systemspecific functions on behalf of the environment system the integral system manages operating system−specific functions on behalf of the environment system and consists of a security system process the lsa a workstation service and a server service the security system process deals with security tokens grants or denies access to user accounts based on resource permissions handles logon requests and initiates logon authentication and determines which system resources need to be audited by the operating system applications can run in user mode where it can run as any principal including in the security context of local system system applications can also run in kernel mode where it would run in the security context of local system system sspi is available through the secur32dll module which is an api used for obtaining integrated security services for authentication message integrity and message privacy it provides an abstraction layer between applicationlevel protocols and security protocols because different applications require different ways of identifying or authenticating users and different ways of encrypting data as it travels across a network sspi provides a way to access dynamiclink libraries dlls containing different authentication and cryptographic functions these dlls are called security support providers ssps managed service accounts and virtual accounts were introduced in windows server 2008 r2 and windows 7 to provide crucial applications such as sql server and iis with the isolation of their own domain accounts while eliminating the need for an administrator to manually administer the service principal name spn and credentials for these accounts for more information about these features and their role in authentication see whats new in service accounts services and kernel mode even though most windows applications run in the security context of the user who starts them this is not true of services many windows services such as network and printing services are launched by the service controller when the user starts the computer these services might run as local service or local system and might continue to run after the last human user logs off note services normally run in security contexts known as local system system network service or local service windows server 2008 r2 introduced services that run under a managed service account which are domain principals before starting a service the service controller logs on by using the account designated for the service and presents the service’s credentials for authentication by the lsa the windows service implements a programmatic interface that the service controller manager can use to control the service a windows service can be started automatically when the system is started or manually with a service control program for example when a windows client computer joins a domain the messenger service on the computer connects to a domain controller and opens a secure channel to it to obtain an authenticated connection the service must have credentials that the remote computer’s local security authority lsa trusts when communicating with other computers in the network lsa uses the credentials for the local computer’s domain account as do all other services running in the security context of the local system and network service services on the local computer run as system so credentials do not need to be presented to lsa the file ksecddsys manages and encrypts these credentials and uses a local procedure call into the lsa the file type is drv driver and is known as the kernelmode security support provider ssp and in windows server 2008 r2 windows server 2008 windows 7 and windows vista is fips 1402 level 1 compliant kernel mode has full access to the hardware and system resources of the computer the kernel mode stops user mode services and applications from accessing critical areas of the operating system that they should not have access to local security authority the local security authority lsa is a protected system process that authenticates and logs users on to the local computer in addition lsa maintains information about all aspects of local security on a computer these aspects are collectively known as the local security policy and it provides various services for translation between names and security identifiers sids the security system process keeps track of the security policies and the accounts that are in effect on a computer system the lsa validates a user’s identity based on which of the following two entities issued the user’s account local security authority the lsa can validate user information by checking its own security accounts manager sam database any workstation or member server can store local user accounts and information about local groups however these accounts can be used for accessing only that workstation or computer security authority for the local domain or for a trusted domain the lsa contacts the entity that issued the account and requests verification that the account is valid and that the request originated from the account holder security accounts manager sam database the security account manager sam is a database that stores local user accounts and groups it is present in every windows operating system however when a computer is joined to a domain active directory manages domain accounts in active directory domains for example client computers running windows participate in a network domain by communicating with a domain controller even when no human user is logged on to initiate communications the computer must have an active account in the domain before accepting communications from the computer the lsa on the domain controller authenticates the computer’s identity and then constructs the computer’s security context just as it would for a human security principal this security context defines the identity and capabilities of a user or service on a particular computer or a user service or computer on a network for example the access token contained within the security context defines the resources such as a file share or printer that can be accessed and the actions such as read write or modify that can be performed by that principal—a user computer or service on that resource the security context of a user or computer can vary from one computer to another such as when a user logs on to a server or a workstation other than the user’s own primary workstation it can also vary from one session to another such as when an administrator modifies the user’s rights and permissions in addition the security context is usually different when a user or computer is operating on a standalone basis in a network or as part of an active directory domain local domains and trusted domains when a trust exists between two domains the authentication mechanisms for each domain relies on the validity of the authentications coming from the other domain trusts help to provide controlled access to shared resources in a resource domain the trusting domain by verifying that incoming authentication requests come from a trusted authority the trusted domain in this way trusts act as bridges that allow only validated authentication requests to travel between domains how a specific trust passes authentication requests depends on how it is configured trust relationships can be oneway providing access from the trusted domain to resources in the trusting domain or twoway providing access from each domain to resources in the other domain trusts are also either nontransitive in which case a trust exists only between the two trust partner domains or transitive in which case a trust automatically extends to any other domains that either of the partners trusts for information about domain and forest trust relationships in regards to authentication see delegated authentication and trust relationships cached credentials and validation validation mechanisms rely on the presentation of credentials at the time of logon however when the computer is disconnected from a domain controller and the user is presenting domain credentials then windows uses the process of cached credentials in the validation mechanism each time a user logs on to a domain windows caches the credentials supplied and stores them in the security hive of the operation system the cached credentials is a function of the nt hash in that the hashed credentials are salted by using the user name and hashed again with cached credentials the user can log on to a domain member without being connected to a domain controller within that domain for more information about cached credentials see the cached and stored credentials technical overview credential storage and validation it is not always desirable to use one set of credentials for access to different resources for example an administrator might want to use administrative rather than user credentials when accessing a remote server similarly if a user will be accessing external resources such as a bank account he or she can only use credentials that are different than their domain credentials there are differences in credential management between  windows 7 windows vista and windows xp stored user names and passwords in windows vista and windows xpin windows server 2008 windows server 2003 windows vista and windows xp stored user names and passwords in control panel simplifies the management and use of multiple sets of logon credentials including x509 certificates used with smart cards and windows live credentials now called microsoft accounts the credentials—part of the user’s profile—are stored until needed this can increase security on a perresource basis by ensuring that if one password is compromised it does not compromise all security after a user logs on and attempts to access additional passwordprotected resources such as a share on a server and if the user’s default logon credentials are not sufficient to gain access stored user names and passwords is queried if alternate credentials with the correct logon information have been saved in stored user names and passwords these credentials are used to gain access otherwise the user is prompted to supply new credentials which can then be saved for reuse either later in the logon session or during a subsequent session the following restrictions apply if stored user names and passwords contains invalid or incorrect credentials for a specific resource access to the resource will be denied and the stored user names and passwords dialog box will not appear stored user names and passwords stores credentials only for ntlm kerberos protocol windows live id and ssl authentication some versions of microsoft internet explorer maintain its own cache for basic authentication these credentials become an encrypted part of a user’s local profile in the documents and settingsusernameapplication datamicrosoftcredentials directory as a result these credentials can roam with the user if the user’s network policy supports roaming profiles however if the user has copies of stored user names and passwords on two different computers and changes the credentials that are associated with the resource on one of these computers the change will not be propagated to stored user names and passwords on the second computer for more information about stored user names and passwords see the cached and stored credentials technical overview windows vault and credential manager in windows 7in windows server 2008 r2 and windows 7 the storage and management of user names and passwords were integrated into credential manager—a control panel feature credential manager allows users to store credentials to other systems and websites in the secure windows vault some versions of internet explorer use this feature for authentication to websites credential management by using credential manager is controlled by the user on the local computer users can save and store credentials from supported browsers and windows applications to make it convenient when they need to sign in to these resources credentials are saved in special encrypted folders on the computer under the user’s profile applications that support this feature through the use of the credential manager apis such as web browsers and apps can present the correct credentials to other computers and websites during the log on process when a website an application or another computer requests authentication through ntlm or the kerberos protocol an update default credentials or save password check box is presented to the user this dialog to request the saving of credentials locally is generated by an application that supports the credential manager apis if the user selects the save password check box credential manager keeps track of the users name password and related information for the authentication service that is in use the next time the service is used credential manager automatically supplies the credential that is stored in the windows vault if it is not accepted the user is prompted for the correct access information if access is granted with the new credentials credential manager overwrites the previous credential with the new one and then stores the new credential in the windows vault certificates in windows authentication a public key infrastructure pki is the combination of software encryption technologies processes and services that enable an organization to secure its communications and business transactions the ability of a pki to secure communications and business transactions is based on the exchange of digital certificates between authenticated users and trusted resources a digital certificate is an electronic document that contains information about the entity it belongs to the entity it was issued by a unique serial number or some other unique identification issuance and expiration dates and a digital fingerprint authentication is the process of determining if a remote host can be trusted to establish its trustworthiness the remote host must provide an acceptable authentication certificate remote hosts establish their trustworthiness by obtaining a certificate from a certification authority ca the ca may in turn have certification from a higher authority and so on creating a chain of trust to determine whether a certificate is trustworthy an application must determine the identity of the root ca and then determine if it is trustworthy similarly the remote host or local computer must determine if the certificate presented by the user or application is authentic the certificate presented by the user through the lsa and sspi is evaluated for authenticity on the local computer for local logon on the network or on the domain through the certificate stores in active directory to produce a certificate authentication data passes through hash algorithms such as secure hash algorithm 1 sha1 to produce a message digest the message digest is then digitally signed by using the sender’s private key to prove that the message digest was produced by the sender smart card authentication smart card technology is an example of certificatebased authentication logging on to a network with a smart card provides a strong form of authentication because it uses cryptographybased identification and proof of possession when authenticating a user to a domain active directory certificate services provides the cryptographicbased identification through the issuance of a logon certificate for each smart card for information about smart card authentication see the windows smart card technical reference remote and wireless authentication remote and wireless network authentication is another technology that uses certificates for authentication the microsoft internet authentication service ias and virtual private network servers use extensible authentication protocoltransport level security eaptls protected extensible authentication protocol peap or internet protocol security ipsec to perform certificatebased authentication for many types of network access including virtual private network vpn and wireless connections for information about certificatebased authentication in networking see network access authentication and certificates see also concepts windows authentication concepts share  theme